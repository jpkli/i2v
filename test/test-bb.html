<!DOCTYPE html>
<html>
    <head>
        <title>i2v Test</title>
        <!-- data-main attribute tells require.js to load
             scripts/main.js after require.js loads. -->

    </head>
    <body>
        <h1>i2v Test</h1>
        <div id="i2vCanvas">
        </div>
        <script src="//d3js.org/d3.v3.min.js"></script>
        <script src="require.js"></script>
        <script>
        require([
            "p4/io/ajax",
            "p4/io/parser",
            "p4/cquery/ctypes",
            "p4/cquery/cstore",
            "p4/core/datastruct",
            "p4/core/pipeline",
            "p4/core/arrays",
            "i2v/charts/scatter",
            "i2v/charts/column",
            'model/dragonfly',
        ],
        function(
            ajax,
            parser,
            ctypes,
            CStore,
            dataStruct,
            pipeline,
            arrays,
            scatterPlot,
            columnChart,
            dragonfly
        ){
            var dataset = "testData/bb-1024-nearest-nb/";
            ajax.getAll([
                 {url: dataset + "dragonfly-msg-stats", dataType: "text"},
                 {url: dataset + "dragonfly-router-stats", dataType: "text"},
                 {url: dataset + "dragonfly-router-traffic", dataType: "text"},
                 {url: dataset + "checkpoint-client-stats", dataType: "text"}
            ]).then(function(text){

                var terminals = dataStruct({
                    array: parser(text[0], " "),
                    header: ["lp_id", "terminal_id", "data_size", "avg_packet_latency", "packets_finished", "avg_hops", "busy_time"],
                    types: ["int", "int", "int", "float", "float", "float", "float"],
                    skip: 1
                }).objectArray();

                var clients = dataStruct({
                    array: parser(text[3], " "),
                    header: ["lp_id", "workload", "client_id", "bytes_written", "data_recieved", "write_time", "total_time"],
                    types: ["int", "string", "int", "int", "int", "float", "float"],
                    skip: 1
                }).objectArray();

                terminals.forEach(function(t, ti){
                    if(ti % 7 == 6) {
                        t.type = "bbNode";
                        t.workload = "bufferburst";
                    }
                    else {
                        t.type = "computeNode";
                        t.workload = "checkpoint";
                    }
                    t.router_id = Math.floor(t.terminal_id / 7);
                    t.router_rank = t.router_id % 14;
                    t.group_id = Math.floor(t.terminal_id / 7 / 14);
                })

                clients.forEach(function(c){
                    var tid = c.client_id + Math.floor(c.client_id / 6);
                    // terminals[tid].workload = (c.workload == "") ? "checkpoint" : c.workload;
                    terminals[tid].workload = c.workload;
                })

                var resultRouter = pipeline()
                .match({
                    workload: "checkpoint"
                })
                .group({
                    $by: "router_rank",
                    data_size: "$sum",
                    busy_time: "$sum"
                })
                .sortBy({router_rank: 1})
                (terminals);

                var resultGroup = pipeline()
                .match({
                    workload: "checkpoint"
                })
                .group({
                    $by: "group_id",
                    data_size: "$sum",
                    busy_time: "$sum"
                })
                .sortBy({group_id: 1})
                (terminals);

                data = Dragonfly({
                    numRouter : dataset.model.num_router,
                    numGroup  : dataset.model.num_group,
                    numNode   : dataset.model.num_node,
                    traffic: traffic,
                    busytime: busytime,
                    terminals: terminals
                });

                // console.log(resultRouter);
                new columnChart({
                    width: 400,
                    height: 150,
                    data: resultRouter,
                    vmap: {x: "router_rank", size: "data_size", color: "busy_time"},
                    padding: {left: 70, bottom: 40, top: 40, right: 20}
                });

                var plotPE = new scatterPlot({
                    width: 400,
                    height: 400,
                    data: resultGroup,
                    vmap: {x: "data_size", y: "busy_time"},
                    // container: "mainView",
                    colors: ["#0A0", "purple"],
                    // title: "PE-Level Statistics",
                    padding: {left: 70, bottom: 40, top: 40, right: 20}
                })
            });
        });

        </script>
    </body>
</html>
