<!DOCTYPE html>
<html>
    <head>
        <title>i2v Test</title>
        <!-- data-main attribute tells require.js to load
             scripts/main.js after require.js loads. -->

    </head>
    <body>
        <h1>i2v Test</h1>
        <div id="i2vCanvas">

        </div>

        <script src="require.js"></script>
        <script>
        require([
            "p4/io/ajax",
            "p4/io/parser",
            "p4/cquery/cstore",
            "i2v/webgl/webgl",
        ],
        function(
            ajax,
            parser,
            CStore,
            WebGL,
            mmts
        ){
            ajax.get({
                 url: "testData.csv", dataType: "text"
            }).then(function(text){
                var csv = parser(text, ',');
                var db = CStore({
                    size: csv.length,
                    struct: [
                        {name: "rank", type: "int"},
                        {name: "chunks_finished", type: "int"},
                        {name: "data_size", type: "int"},
                        {name: "hops_finished", type: "float"},
                        {name: "time_spend", type: "float"},
                        {name: "busy_time", type: "float"},
                        {name: "timestamp", type: "float"}
                    ],
                });

                db.addRows(csv);

                // db.filter({timestamp: 1000});

                console.log(db.info());

                var data = db.data(),
                    metadata = db.metadata();

                var webgl = WebGL({
                    container: "i2vCanvas",
                    height: 100,
                    width: 1200,
                    // margin: padding
                });

                var posXdata= data.get("timestamp");
                //
                //setup all attributes, uniform, texture, varying needed by all the shaders
                webgl.uniform("vec2", "xDomain", [metadata.stats["timestamp"].min, metadata.stats["timestamp"].max])
                    .uniform("vec2", "yDomain", [metadata.stats["rank"].min, metadata.stats["rank"].max])
                    .uniform("vec4", "u_color", [0.25, 0.545, 0.667, 1.0])
                    .framebuffer("test", 1024, 128)
                    .attribute("vec2", "pos",  new Float32Array([-1.0, -1.0, 1.0, -1.0, -1.0,  1.0, -1.0,  1.0, 1.0, -1.0, 1.0,  1.0]));

                function mainVert(){
                    gl_Position = vec4(pos, 0.0, 1.0);
                }

                // function mainVert(){
                //
                //     $float.x = (pos.x - xDomain.x) / (xDomain.y - xDomain.x) * 2.0 - 1.0;
                //     $float.y = (pos.y - yDomain.x) / (yDomain.y - yDomain.x)  * 2.0 - 1.0;
                //
                //
                //     gl_Position = vec4(x, y, 0.0, 1.0);
                //
                // }

                function mainFrag() {
                    gl_FragColor = vec4(1,0,0,10.05363);
                }

                var vs = webgl.shader()
                    .vertex()
                     .require([ "pos",])
                    .function("void", "main", mainVert)
                    .init();

                var fs = webgl.shader().fragment().require(["u_color"]).function("void", "main", mainFrag).init();

                var gl = webgl.program([vs, fs]);

                // gl.clearColor(1.0,1.0,1.0,1.0);
                // gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT );
                // gl.enable( gl.BLEND );
                // gl.blendEquation( gl.FUNC_ADD );
                // gl.blendFunc( gl.ONE, gl.ONE_MINUS_SRC_ALPHA );
                //
                // var a = 0.5;
                // webgl.uniform.u_color = [0.25 * a, 0.545*a, 0.667*a, a];
                // gl.viewport(0, 0, 1024, 128)
                gl.bindFramebuffer(gl.FRAMEBUFFER, framebuffer["test"]);
                gl.drawArrays(gl.TRIANGLES, 0, 6);

                // gl.bindFramebuffer(gl.FRAMEBUFFER, null);
                var pixels = new Float32Array(4 *1200 * 60);
                gl.readPixels(0, 0, 1200, 60, gl.RGBA, gl.FLOAT, pixels);

                console.log(pixels);
            });
        });
        </script>
    </body>
</html>
