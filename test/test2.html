<!DOCTYPE html>
<html>
    <head>
        <title>i2v Test</title>
        <!-- data-main attribute tells require.js to load
             scripts/main.js after require.js loads. -->

    </head>
    <body>
        <h1>i2v Test</h1>
        <div id="i2vCanvas">

        </div>

        <script src="require.js"></script>
        <script src="i2v.js"></script>
        <script>
        require([
            "p4/io/ajax",
            "p4/io/parser",
            "p4/cquery/cstore",
            "i2v/webgl/webgl",
            "mmts",
        ],
        function(
            ajax,
            parser,
            CStore,
            WebGL,
            mmts
        ){
            ajax.get({
                 url: "testData.csv", dataType: "text"
            }).then(function(text){
                var csv = parser(text, ',');
                var db = CStore({
                    size: csv.length,
                    struct: [
                        {name: "rank", type: "int"},
                        {name: "chunks_finished", type: "int"},
                        {name: "data_size", type: "int"},
                        {name: "hops_finished", type: "float"},
                        {name: "time_spend", type: "float"},
                        {name: "busy_time", type: "float"},
                        {name: "timestamp", type: "int"}
                    ],
                });

                db.addRows(csv);

                var webgl = WebGL({
                    container: "i2vCanvas",
                    height: 600,
                    width: 1200,
                    // margin: padding
                });


                var data = db.data(),
                    metadata = db.metadata();

                console.log(metadata);

                //
                //calculate the size of the texture (texture size must be power of 2)
                var attributes = ["data_size", "busy_time", "time_spend", "hops_finished"],
                    numSeries = metadata.stats["rank"].max+1,
                    numTimeSteps = metadata.stats["timestamp"].max / metadata.stats["timestamp"].min,
                    texWidth = Math.pow(2, Math.ceil(Math.log2(numTimeSteps))),
                    texHeight = Math.pow(2, Math.ceil(Math.log2(numSeries)));

                    mmts({
                        data: data,
                        stats:  metadata.stats,
                        width: 1200,
                        height: 500,
                        // exponent: exponent,
                        vmap: {x: "timestamp", y: "data_size"},
                        container:"i2vCanvas",
                        timesteps: numTimeSteps,
                        // ts: ts,
                        alpha: 0.5,
                        // color: tsColor(attributes[0]),
                        // aggregation: binAggregatedData,
                        formatX: function(d) { return d },
                        formatY: function(d) { return d },
                    });
            });
        });
        </script>
    </body>
</html>
